<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Sudhakar's Blog</title>
    <meta name="viewport" content="width=device-width">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon"/>

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/fontello.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/list.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/drawing_theme.css">

    <script src="/scripts/jquery-1.10.2.js"></script>
    <script src="/scripts/underscore-min.js"></script>
    <script src="/scripts/default.js"></script>
    <script src="/scripts/post.js"></script>
</head>

<body class="drawing_theme">

<div class="site_header">
    <i class="icon icon-art-gallery theme-selector"></i>
    <i class="icon icon-home"></i>
    <div class="blogger"><a href="https://twitter.com/SudhakarRay" target="_blank">Sudhakar R</a></div>

    <div id="filter_dock">
        <i
          class="icon icon-programming selector" data-category="programming"></i><i
          class="icon icon-cartoon selector" data-category="cartoon"></i><i
          class="icon icon-visualization selector" data-category="visualization"></i><i
          class="icon icon-social selector" data-category="social"></i><i
          class="icon icon-diy selector" data-category="diy"></i><i
          class="icon icon-deselect"></i>
    </div>

</div>

<div id="post_list">
</div>

<div id="post_backdrop">
    <div id="post_container">
        <div class="left"></div>
        <div class="content">
            <div class="post_heading">
                <div class="date">17 Feb 2014</div>
                <div class="title_section">Externalize JDBI queries</div>
            </div>

            <div class="post">
                <p>Usual style of writing queries with <a href="http://jdbi.org/">JDBI</a> is to embed them in method level annotations like below</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span>     <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">WhyDao</span> <span class="o">{</span>
<span class="lineno">2</span>         <span class="nd">@SqlQuery</span><span class="o">(</span><span class="s">&quot;select * from whytable where name = :name order by created_date&quot;</span><span class="o">)</span>
<span class="lineno">3</span>         <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Why</span><span class="o">&gt;</span> <span class="nf">getWhys</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="lineno">4</span>     <span class="o">}</span></code></pre></figure>

<p>This type of embedding queries is good for small ones. Since java does not (yet) support multiline strings, this style
gets messy with long queries (I am talking about queries that goes beyond 3 lines with sensible line widths).</p>

<p><br/></p>

<p>Fortunately JDBI offers an alternate if you really wanted to keep the queries easily readable and editable.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span>     <span class="nd">@OverrideStatementLocatorWith</span><span class="o">(</span><span class="n">QueryLocator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="lineno">2</span>     <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">WhyDao</span> <span class="o">{</span>
<span class="lineno">3</span>         <span class="nd">@SqlQuery</span>
<span class="lineno">4</span>         <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Why</span><span class="o">&gt;</span> <span class="nf">getWhys</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="lineno">5</span>     <span class="o">}</span></code></pre></figure>

<p>Above is the same class rewritten by externalizing the query string. The key element in this code is the annotation
<a href="http://jdbi.codehaus.org/maven_site/apidocs/org/skife/jdbi/v2/sqlobject/customizers/OverrideStatementLocatorWith.Factory.html">@OverrideStatementLocatorWith</a>.
It takes in a subclass of <a href="http://jdbi.codehaus.org/maven_site/apidocs/org/skife/jdbi/v2/tweak/class-use/StatementLocator.html">StatementLocator</a> class
(QueryLocator here) which will have the strategy to find the sql string to use.</p>

<p>An example implementation of StatementLocator might look like this</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span>     <span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueryLocator</span> <span class="kd">implements</span> <span class="n">StatementLocator</span> <span class="o">{</span>
<span class="lineno"> 2</span>         <span class="nd">@Override</span>
<span class="lineno"> 3</span>         <span class="kd">public</span> <span class="n">String</span> <span class="nf">locate</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">StatementContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="lineno"> 4</span>             <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Queries</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="lineno"> 5</span>             <span class="k">if</span> <span class="o">(</span><span class="n">query</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>                 <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Unable to find any query for &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="o">);</span>
<span class="lineno"> 7</span>             <span class="o">}</span>
<span class="lineno"> 8</span>             <span class="k">return</span> <span class="n">query</span><span class="o">;</span>
<span class="lineno"> 9</span>         <span class="o">}</span>
<span class="lineno">10</span>     <span class="o">}</span></code></pre></figure>

<p><strong>name</strong> parameter will contain the method name (in our case <strong>&#39;getWhys&#39;</strong>) which can be use to find the appropriate query string.
<strong>Queries</strong> class is my custom singleton class which loads all the queries from external text file(s) containing sqls during bootstrap.</p>

            </div>


        </div>
        <div class="right"></div>
    </div>
</div>

<script>
    initPost();
</script>


<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-26664903-1', 'rsudhakar.in');
    ga('send', 'pageview');
</script>
</body>
</html>
