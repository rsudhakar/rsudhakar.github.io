<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Programs View</title>
    <link rel="stylesheet" href="styles.css"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.0/lodash.min.js"></script>
    <script>

        function ProgramView(config) {
            var svg = d3.select(config.container).append("svg");
            var elementDimensions = $(config.container)[0].getBoundingClientRect();
            var sortedDates = _.sortBy(_.pluck(config.data, 'date'));
            var uniqueStates = _.uniq(_.pluck(config.data, 'state'));
            var xMin = 25, xMax = elementDimensions.width-35;
            var timeScale = d3.time.scale()
                    .domain([sortedDates[0], new Date()])
                    .range([xMin,xMax]);
            var timeAxis = d3.svg.axis()
                    .orient("bottom")
                    .scale(timeScale)
                    .tickFormat(d3.time.format("%_d %b%y"))
                    .tickValues(sortedDates)
                    .tickPadding(6);
            svg.append("g")
                    .attr("class", "xaxis")
                    .attr("transform", "translate(0,35)")
                    .call(timeAxis);
            var colors = d3.scale.category10();
            var states = svg.selectAll('.states').data(config.data);
            states.enter().append('rect').classed('states',true);
            states.attr('x', function(d) { return timeScale(d.date); })
                    .attr('y', 9)
                    .attr('height', 26)
                    .attr('width', function(d) { return xMax-timeScale(d.date)})
                    .style('fill', function(d) {return colors(_.indexOf(uniqueStates, d.state))});

            //Draw completed state
            if(!config.completed) {
                svg.append("polygon")
                        .attr("points", (xMax + "," + 9 + " " + (xMax+13) + "," + 22 + " " + xMax + "," + 35))
                        .attr("fill", colors(_.indexOf(uniqueStates, _.last(config.data).state)));
            }

            //Draw Legend
            var legendContainer = d3.select(config.container).append("div").classed("legend", true);
            var legendItems = legendContainer.selectAll(".item").data(uniqueStates);
            legendItems.enter().append("div").classed("item",true);
            legendItems.style("background-color", function(d,i) { return colors(i)})
                    .text(function(d) { return d});
        }

    </script>
</head>

<body>
<div id="container" style="width:800px;">
</div>
<script>
    var somedata = [
        {state: "Admitted", date: new Date(2015,1,1)},
        {state: "Counselling", date: new Date(2015,2,6)},
        {state: "Medication", date: new Date(2015,3,12)},
        {state: "Counselling", date: new Date(2015,4,6)},
        {state: "Curing", date: new Date(2015,6,6)}
    ];

    var configInfo = {
        container: "#container",
        data: somedata,
        completed: false
    }
    new ProgramView(configInfo);
</script>
</body>
</html>